RewriteEngine On

# Set proper MIME types for JavaScript modules and fonts (critical for ES modules and font loading)
<IfModule mod_mime.c>
  AddType application/javascript .js
  AddType application/javascript .mjs
  AddType text/css .css
  # Font MIME types
  AddType font/woff .woff
  AddType font/woff2 .woff2
  AddType font/ttf .ttf
  AddType font/otf .otf
  AddType font/eot .eot
  AddType application/font-woff .woff
  AddType application/font-woff2 .woff2
  AddType application/font-ttf .ttf
  AddType application/font-otf .otf
  AddType application/vnd.ms-fontobject .eot
</IfModule>

# Cache Control Headers for Static Assets
<IfModule mod_expires.c>
  ExpiresActive On
  
  # Images - 1 year
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/jpg "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"
  ExpiresByType image/ico "access plus 1 year"
  
  # Fonts - 1 year (all possible MIME types)
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/ttf "access plus 1 year"
  ExpiresByType font/otf "access plus 1 year"
  ExpiresByType font/eot "access plus 1 year"
  ExpiresByType application/font-woff "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"
  ExpiresByType application/font-ttf "access plus 1 year"
  ExpiresByType application/font-otf "access plus 1 year"
  ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
  
  # CSS and JavaScript - 1 year (with hash-based versioning)
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType text/javascript "access plus 1 year"
  
  # Video - 1 month
  ExpiresByType video/mp4 "access plus 1 month"
  ExpiresByType video/webm "access plus 1 month"
  
  # Default - 1 week for other static files
  ExpiresDefault "access plus 1 week"
</IfModule>

# Cache-Control Headers (fallback if mod_expires is not available)
# IMPORTANT: These headers must be set BEFORE rewrite rules to ensure they apply
<IfModule mod_headers.c>
  # Images - 1 year
  <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico)$">
    Header set Cache-Control "max-age=31536000, public, immutable"
    Header unset ETag
    FileETag None
  </FilesMatch>
  
  # Fonts - 1 year (with immutable flag for hash-based versioning)
  <FilesMatch "\.(woff|woff2|ttf|otf|eot)$">
    Header set Cache-Control "max-age=31536000, public, immutable"
    Header unset ETag
    FileETag None
  </FilesMatch>
  
  # CSS and JavaScript - 1 year (with hash-based versioning)
  <FilesMatch "\.(css|js|mjs)$">
    Header set Cache-Control "max-age=31536000, public, immutable"
    Header unset ETag
    FileETag None
  </FilesMatch>
  
  # Video - 1 month
  <FilesMatch "\.(mp4|webm)$">
    Header set Cache-Control "max-age=2592000, public"
  </FilesMatch>
  
</IfModule>

# Additional cache headers for assets directory (using LocationMatch for better compatibility)
<IfModule mod_headers.c>
  <LocationMatch "^/assets/.*\.(woff|woff2|ttf|otf|eot|css|js|mjs|jpg|jpeg|png|gif|webp|svg|ico)$">
    Header set Cache-Control "max-age=31536000, public, immutable"
    Header unset ETag
    FileETag None
  </LocationMatch>
</IfModule>

# Force HTTPS & non-www domain (skip for assets to avoid redirect loops)
RewriteCond %{REQUEST_URI} !^/assets/
RewriteCond %{REQUEST_URI} !\.(js|mjs|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|otf|eot|mp4|webm|json|xml|txt|zip)$
RewriteCond %{HTTPS} !=on [OR]
RewriteCond %{HTTP_HOST} ^www\.tikit\.ae [NC]
RewriteRule ^ https://tikit.ae%{REQUEST_URI} [L,R=301]

RewriteBase /

# CRITICAL: Serve JavaScript files directly - MUST come first
# If it's a .js or .mjs file that exists, serve it immediately
RewriteCond %{REQUEST_FILENAME} -f
RewriteCond %{REQUEST_URI} \.(js|mjs)$ [NC]
RewriteRule ^ - [L]

# CRITICAL: Return 404 for missing JS files (don't serve index.html for missing JS)
# This prevents MIME type errors when JS files don't exist
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} \.(js|mjs)$ [NC]
RewriteRule ^ - [R=404,L]

# CRITICAL: Serve assets directory files directly
# If file exists in /assets/, serve it immediately (before any other checks)
RewriteCond %{REQUEST_URI} ^/assets/
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Serve any other existing static files directly
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Serve any existing directories directly
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# React SPA fallback - only for non-file, non-directory, non-JS requests
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !\.(js|mjs)$ [NC]
RewriteRule .* /index.html [L]